<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Entregador | Locadora do Vale</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
:root{
--yellow:#ffcc00;
--orange:#ff6600;
--bg:#0a0a0a;
--card:#1a1a1a;
--border:rgba(255,255,255,.1);
}
*{box-sizing:border-box;font-family:Outfit,sans-serif}
body{margin:0;background:var(--bg);color:#fff}
header{padding:16px;text-align:center;border-bottom:2px solid var(--yellow)}
.container{max-width:650px;margin:auto;padding:20px}
.btn-som{width:100%;padding:14px;margin-bottom:20px;background:transparent;border:1px solid var(--yellow);color:var(--yellow);border-radius:12px;font-weight:800;cursor:pointer}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:20px}
.label{font-size:12px;color:var(--yellow);text-transform:uppercase;font-weight:800;margin-top:10px}
.value{font-size:16px;font-weight:600;margin-bottom:10px}
.itens-box{background:#111;border:1px solid var(--border);border-radius:12px;padding:10px}
.item-linha{color:#ccc;margin:4px 0}
.actions{margin-top:15px;display:grid;gap:10px}
.btn{padding:12px;border-radius:10px;text-decoration:none;font-weight:800;text-align:center}
.btn-mapa{border:1px solid var(--border);color:#fff}
.btn-pegar{background:linear-gradient(135deg,var(--yellow),var(--orange));color:#000}
.vazio{text-align:center;margin-top:80px;color:#777}
.vazio i{font-size:60px;color:var(--yellow);opacity:.3}
</style>
</head>
<body>

<header>
<h2><i class="fas fa-truck-loading"></i> Coletas Pendentes</h2>
</header>

<div class="container">

<button class="btn-som" onclick="ativarSom()">ðŸ”Š Ativar notificaÃ§Ãµes sonoras</button>

<audio id="som" preload="auto">
<source src="/static/notificacao.mp3" type="audio/mpeg">
</audio>

<div id="lista">
{% for p in pedidos %}
<div class="card" id="pedido-{{p.id}}">
<div class="label">Cliente</div>
<div class="value">{{p.cliente}}</div>

<div class="label">EndereÃ§o</div>
<div class="value">{{p.endereco}}</div>

<div class="label">Itens</div>
<div class="itens-box">
{% for i in p.itens %}
<div class="item-linha">â€¢ {{i.nome}} ({{i.qtd}}x)</div>
{% endfor %}
</div>

<div class="actions">
<a class="btn btn-mapa" target="_blank"
href="https://www.google.com/maps/search/?api=1&query={{ p.endereco | urlencode }}+Aruan%C3%A3+GO}">
ðŸ§­ Rota no mapa
</a>

<a class="btn btn-pegar" href="/pegar/{{p.id}}">âœ… Confirmar coleta</a>
</div>
</div>
{% else %}
<div class="vazio" id="vazio">
<i class="fas fa-box-open"></i>
<p>Nenhuma coleta pendente</p>
</div>
{% endfor %}
</div>
</div>

<script>
const socket = io({transports:["websocket"],upgrade:false,reconnection:true});

socket.on("connect", ()=>{
  console.log("âœ… Conectado");

  // sincroniza pedidos ao conectar/reconectar
  fetch("/api/pendentes")
    .then(r=>r.json())
    .then(lista=>{
      document.getElementById("lista").innerHTML="";
      if(lista.length===0){
        document.getElementById("lista").innerHTML=vazioHTML();
      }else{
        lista.forEach(p=>{
          const c=criarCard(p);
          if(c) document.getElementById("lista").appendChild(c);
        });
      }
    });
});

let somAtivo=false;

function ativarSom(){
 const audio=document.getElementById("som");
 audio.play().then(()=>{
   audio.pause();
   somAtivo=true;
   alert("ðŸ”Š Som ativado!");
 });
}

function tocarSom(){
 if(!somAtivo) return;
 const audio=document.getElementById("som");
 audio.currentTime=0;
 audio.play().catch(()=>{});
}

function criarCard(p){
 if(document.getElementById("pedido-"+p.id)) return null;

 if(!p.itens) p.itens=[];

 let itensHtml="";
 p.itens.forEach(i=>{
   itensHtml+=`<div class="item-linha">â€¢ ${i.nome} (${i.qtd}x)</div>`;
 });

 const div=document.createElement("div");
 div.className="card";
 div.id="pedido-"+p.id;

 div.innerHTML=`
<div class="label">Cliente</div>
<div class="value">${p.cliente}</div>
<div class="label">EndereÃ§o</div>
<div class="value">${p.endereco}</div>
<div class="label">Itens</div>
<div class="itens-box">${itensHtml}</div>
<div class="actions">
<a class="btn btn-mapa" target="_blank"
href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.endereco+" AruanÃ£ GO")}">ðŸ§­ Rota no mapa</a>
<a class="btn btn-pegar" href="/pegar/${p.id}">âœ… Confirmar coleta</a>
</div>`;
 return div;
}

function vazioHTML(){
 return `<div class="vazio" id="vazio">
<i class="fas fa-box-open"></i>
<p>Nenhuma coleta pendente</p></div>`;
}

socket.on("novo_pedido",p=>{
 tocarSom();

 if(Notification.permission==="granted"){
  new Notification("ðŸšš Nova coleta",{body:`${p.cliente}\n${p.endereco}`});
 }

 const v=document.getElementById("vazio");
 if(v) v.remove();

 const c=criarCard(p);
 if(c) document.getElementById("lista").prepend(c);
});

socket.on("pedido_atualizado",d=>{
 const el=document.getElementById("pedido-"+d.id);
 if(el) el.remove();

 if(document.querySelectorAll(".card").length===0){
  document.getElementById("lista").innerHTML=vazioHTML();
 }
});

if("Notification" in window && Notification.permission!=="granted"){
 Notification.requestPermission();
}
</script>

</body>
</html>
