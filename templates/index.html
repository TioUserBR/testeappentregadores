<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel do Atendente</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f3f4f6}
header{background:#2563eb;color:#fff;padding:15px;text-align:center;font-weight:bold}
.container{padding:15px;max-width:900px;margin:auto}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
input,button{padding:10px;border-radius:6px;border:1px solid #ccc;width:100%;margin-top:8px}
button{background:#2563eb;color:#fff;border:none}
#mapa{height:300px;margin-top:10px;border-radius:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid #ddd}
</style>
</head>
<body>

<header>üì¶ Sistema de Coleta ‚Äì Atendente</header>

<div class="container">

<div class="card">
<h3>Novo pedido</h3>

<form action="/enviar" method="post">

<input name="cliente" placeholder="Cliente" required>
<input name="ferramenta" placeholder="Ferramenta" required>
<input name="quantidade" type="number" placeholder="Quantidade" required>

<input id="enderecoBusca" placeholder="Cidade ou endere√ßo (ex: Rua X, Aruan√£ GO)" required>

<button type="button" onclick="buscarEndereco()">üìç Buscar no mapa</button>

<input id="enderecoFinal" name="endereco" placeholder="Endere√ßo confirmado" readonly required>

<div id="mapa"></div>

<br>
<button type="submit">Enviar para entregador</button>

</form>
</div>

<div class="card">
<h3>Pedidos pendentes</h3>

<table>
<tr><th>Cliente</th><th>Endere√ßo</th><th>Ferramenta</th><th>Qtd</th></tr>

{% for p in pedidos %}
<tr>
<td>{{p.cliente}}</td>
<td>{{p.endereco}}</td>
<td>{{p.ferramenta}}</td>
<td>{{p.quantidade}}</td>
</tr>
{% else %}
<tr><td colspan="4">Nenhum pedido</td></tr>
{% endfor %}
</table>

</div>
</div>

<script>
const mapa = L.map('mapa').setView([-13.0206, -50.9236], 13);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(mapa);

let marcador = null;

function buscarEndereco(){

  const texto = document.getElementById("enderecoBusca").value;

  if(!texto){
    alert("Digite o endere√ßo ou cidade.");
    return;
  }

  const busca = texto + ", Aruan√£ GO";

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(busca)}`)
    .then(r=>r.json())
    .then(d=>{

      if(!d.length){
        alert("Endere√ßo n√£o encontrado.");
        return;
      }

      const lat = d[0].lat;
      const lon = d[0].lon;

      mapa.setView([lat, lon], 16);

      if(marcador) mapa.removeLayer(marcador);

      marcador = L.marker([lat, lon]).addTo(mapa);

      document.getElementById("enderecoFinal").value = d[0].display_name;

    })
    .catch(()=>{
      alert("Erro ao buscar endere√ßo.");
    });
}
</script>

</body>
</html>
